<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JD Analytics &amp; Solutions — Tailored Industry Updates</title>

  <!-- bump ?v to bust cache when you change CSS -->
  <link rel="stylesheet" href="/static/style.css?v=2026-01-03-a" />
  <style>
    .hidden{display:none!important}
    .error{color:#ff99aa}
    .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-size:.85rem}
    .stack{display:flex;flex-wrap:wrap;gap:.5rem}
    .grid{display:grid;gap:12px}
    @media(min-width: 980px){ .grid.cols2{grid-template-columns: 1fr 1fr} }
    @media(min-width: 1200px){ .grid.cols4{grid-template-columns: repeat(4, 1fr)} }
    .section-title{display:flex;align-items:baseline;justify-content:space-between;gap:12px}
    .section-title h2{margin:0}
    .hint{opacity:.8}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .toolbar .left, .toolbar .right{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select, button, input{font:inherit}
    .btn{cursor:pointer;border-radius:10px;padding:.55rem .8rem;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:inherit}
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{border-color:rgba(0,160,255,.35)}
    .badge{padding:.25rem .55rem;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:.8rem}
    .badge.ok{border-color:rgba(80,220,140,.55)}
    .badge.err{border-color:rgba(255,120,140,.55)}
    .cards{display:grid;gap:10px}
    @media(min-width: 980px){ .cards{grid-template-columns: repeat(2, 1fr)} }
    @media(min-width: 1200px){ .cards{grid-template-columns: repeat(3, 1fr)} }
    .carditem{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:14px;padding:12px}
    .carditem .t{font-weight:650;margin:0 0 4px 0}
    .carditem .d{opacity:.8;font-size:.85rem;margin:0 0 8px 0}
    .carditem .b{opacity:.92;margin:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .empty{opacity:.75;padding:14px}
    details{border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);padding:10px}
    details summary{cursor:pointer}
    pre{white-space:pre-wrap;word-wrap:break-word}
    a{color:inherit}
  </style>
</head>

<body>
  <!-- Top Bar -->
  <header class="appbar">
    <div class="title">JD Analytics &amp; Solutions — Tailored Industry Updates</div>
    <div class="right stack">
      <span class="pill">Build: 2026-01-03a</span>
      <span class="pill" id="apiPill">API: …</span>
    </div>
  </header>

  <main class="container">
    <!-- Status -->
    <section class="card" aria-label="Status">
      <div class="toolbar">
        <div class="left">
          <span class="badge" id="statusBadge">Checking…</span>
          <span id="statusText">Warming up API.</span>
        </div>
        <div class="right">
          <span class="hint">Docs: <a id="docsLink" href="#" target="_blank" rel="noopener">/docs</a></span>
          <button class="btn primary" id="refreshBtn">Refresh</button>
        </div>
      </div>
    </section>

    <!-- Controls -->
    <section class="card" aria-label="Controls">
      <div class="toolbar">
        <div class="left">
          <label class="pill" for="topSelect">Rows per section
            <select id="topSelect" style="margin-left:.5rem">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </label>

          <label class="pill" for="viewSelect">View
            <select id="viewSelect" style="margin-left:.5rem">
              <option value="cards" selected>Cards</option>
              <option value="raw">Raw JSON (debug)</option>
            </select>
          </label>

          <span class="pill">Sort: <span class="mono">createdon desc</span></span>
        </div>

        <div class="right">
          <span class="pill">Endpoint: <span class="mono">/api/v1/summary/industry-updates</span></span>
        </div>
      </div>
    </section>

    <!-- INDUSTRY: 4-up grid -->
    <section class="card" aria-label="Industry Updates">
      <div class="section-title">
        <h2 class="card-title">Industry Updates</h2>
        <span class="hint">Latest records by section (Dataverse raw — all columns)</span>
      </div>

      <div class="grid cols4" style="margin-top:12px">
        <div>
          <div class="section-title">
            <h3 style="margin:0">Real Estate</h3>
            <span class="hint" id="count_real_estate"></span>
          </div>
          <div id="real_estate" class="cards"></div>
        </div>

        <div>
          <div class="section-title">
            <h3 style="margin:0">Automotive</h3>
            <span class="hint" id="count_automotive"></span>
          </div>
          <div id="automotive" class="cards"></div>
        </div>

        <div>
          <div class="section-title">
            <h3 style="margin:0">Business Analytics &amp; Ops</h3>
            <span class="hint" id="count_analytics_ops"></span>
          </div>
          <div id="analytics_ops" class="cards"></div>
        </div>

        <div>
          <div class="section-title">
            <h3 style="margin:0">AI Developments</h3>
            <span class="hint" id="count_ai"></span>
          </div>
          <div id="ai" class="cards"></div>
        </div>
      </div>
    </section>

    <!-- MARKET: 2x2 grid -->
    <section class="card" aria-label="Market Updates">
      <div class="section-title">
        <h2 class="card-title">Market &amp; Outlook</h2>
        <span class="hint">General market sections (insights, outlook, trends, analysis)</span>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div>
          <div class="section-title">
            <h3 style="margin:0">Market Insight</h3>
            <span class="hint" id="count_market"></span>
          </div>
          <div id="market" class="cards"></div>
        </div>

        <div>
          <div class="section-title">
            <h3 style="margin:0">Market Outlook</h3>
            <span class="hint" id="count_outlook"></span>
          </div>
          <div id="outlook" class="cards"></div>
        </div>

        <div>
          <div class="section-title">
            <h3 style="margin:0">Market Trends</h3>
            <span class="hint" id="count_trends"></span>
          </div>
          <div id="trends" class="cards"></div>
        </div>

        <div>
          <div class="section-title">
            <h3 style="margin:0">Market Analysis</h3>
            <span class="hint" id="count_analysis"></span>
          </div>
          <div id="analysis" class="cards"></div>
        </div>
      </div>
    </section>

    <!-- Debug panel -->
    <section class="card" aria-label="Debug" id="debugCard" style="display:none">
      <div class="section-title">
        <h2 class="card-title">Raw Payload (Debug)</h2>
        <span class="hint">Useful while column names are still evolving</span>
      </div>
      <details style="margin-top:10px" open>
        <summary>Show JSON</summary>
        <pre class="mono" id="rawJson">(loading)</pre>
      </details>
    </section>

    <div class="spacer"></div>
  </main>

  <script>
    // ---------- API base (same-origin) ----------
    const API_BASE = `${location.protocol}//${location.host}`;
    const apiPill  = document.getElementById("apiPill");
    if (apiPill) apiPill.textContent = `API: ${API_BASE}`;
    const docsLink = document.getElementById("docsLink");
    if (docsLink) docsLink.href = `${API_BASE}/docs`;

    // ---------- Refs ----------
    const $ = s => document.querySelector(s);
    const statusB   = $("#statusBadge");
    const statusT   = $("#statusText");
    const refreshBtn= $("#refreshBtn");
    const topSelect = $("#topSelect");
    const viewSelect= $("#viewSelect");
    const debugCard = $("#debugCard");
    const rawJson   = $("#rawJson");

    const BLOCK_IDS = ["real_estate","automotive","analytics_ops","ai","market","outlook","trends","analysis"];

    function setStatus(kind, text){
      statusB?.classList.remove("ok","err");
      if (kind === "ok")  statusB?.classList.add("ok");
      if (kind === "err") statusB?.classList.add("err");
      if (statusB) statusB.textContent = (kind==="ok" ? "OK" : kind==="err" ? "Error" : "Loading…");
      if (statusT) statusT.textContent = text || "";
    }

    async function fetchJSON(path){
      const url = `${API_BASE}${path}`;
      const res = await fetch(url, { cache:"no-store", headers:{ "Accept":"application/json" }});
      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${url}\n${txt.slice(0,300)}`);
      }
      return res.json();
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function pickTitle(row){
      // Try common title-like fields; otherwise show primary id-ish key
      const candidates = [
        "jdas_title","jdas_headline","jdas_name","name","title","subject"
      ];
      for (const k of candidates){
        if (row && row[k]) return String(row[k]);
      }
      // fall back to first string field
      if (row && typeof row === "object"){
        for (const [k,v] of Object.entries(row)){
          if (typeof v === "string" && v.trim()) return v;
        }
      }
      return "Update";
    }

    function pickBody(row){
      const candidates = [
        "jdas_summary","jdas_description","summary","description","jdas_notes","notes"
      ];
      for (const k of candidates){
        if (row && row[k]) return String(row[k]);
      }
      return "";
    }

    function pickDate(row){
      const d = row?.createdon || row?.modifiedon || row?.jdas_date || row?.date;
      if (!d) return "";
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString();
    }

    function renderCards(blockId, items){
      const mount = document.getElementById(blockId);
      const countEl = document.getElementById(`count_${blockId}`);
      if (!mount) return;

      if (!Array.isArray(items) || items.length === 0){
        mount.innerHTML = `<div class="empty">No recent records.</div>`;
        if (countEl) countEl.textContent = "";
        return;
      }

      if (countEl) countEl.textContent = `${items.length} shown`;

      mount.innerHTML = items.map(row => {
        const t = pickTitle(row);
        const d = pickDate(row);
        const b = pickBody(row);
        return `
          <div class="carditem">
            <div class="t">${escapeHTML(t)}</div>
            <div class="d">${escapeHTML(d)}</div>
            ${b ? `<div class="b">${escapeHTML(b).slice(0,260)}</div>` : ``}
          </div>
        `;
      }).join("");
    }

    function clearAll(){
      for (const id of BLOCK_IDS){
        const el = document.getElementById(id);
        const countEl = document.getElementById(`count_${id}`);
        if (el) el.innerHTML = `<div class="empty">Loading…</div>`;
        if (countEl) countEl.textContent = "";
      }
    }

    async function loadSummary(){
      const top = parseInt(topSelect?.value || "10", 10);
      clearAll();
      setStatus("", "Loading updates…");

      const data = await fetchJSON(`/api/v1/summary/industry-updates?top=${top}`);

      if (!data || data.ok !== true){
        setStatus("err", "API returned an error payload.");
        if (rawJson) rawJson.textContent = JSON.stringify(data, null, 2);
        return;
      }

      const blocks = data.blocks || {};
      for (const id of BLOCK_IDS){
        const blk = blocks[id];
        renderCards(id, blk?.items || []);
      }

      // Debug toggle
      const view = viewSelect?.value || "cards";
      if (debugCard){
        debugCard.style.display = (view === "raw") ? "block" : "none";
      }
      if (rawJson){
        rawJson.textContent = JSON.stringify(data, null, 2);
      }

      setStatus("ok", "Loaded latest updates.");
    }

    // ---------- Health warmup (try /api/health then /health) ----------
    async function warmup(){
      for (let i=0;i<6;i++){
        try {
          const j = await fetchJSON("/api/health");
          if (j && j.ok){ setStatus("ok","API ready."); return; }
        } catch {}
        try {
          const j2 = await fetchJSON("/health");
          if (j2 && j2.ok){ setStatus("ok","API ready."); return; }
        } catch {}
        setStatus("", "Warming API…");
        await new Promise(r=>setTimeout(r,4000));
      }
      setStatus("err","API did not warm up (yet). Try Refresh.");
    }

    // events
    refreshBtn?.addEventListener("click", () => loadSummary().catch(err => {
      console.error(err);
      setStatus("err", "Failed to load updates.");
    }));

    topSelect?.addEventListener("change", () => loadSummary().catch(console.error));
    viewSelect?.addEventListener("change", () => {
      if (debugCard){
        debugCard.style.display = (viewSelect.value === "raw") ? "block" : "none";
      }
    });

    // boot
    (async ()=>{
      await warmup();
      await loadSummary();
    })();
  </script>
</body>
</html>
