<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JD Analytics â€” Industry Insights</title>
  <link rel="stylesheet" href="/static/style.css?v=2.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
  <header class="appbar">
    <div class="title">JD ANALYTICS</div>
    <div class="right">
      <button class="btn primary" id="refreshBtn">Refresh Data</button>
    </div>
  </header>

  <main class="container">
    
    <div class="toolbar">
      <div class="group">
        <span class="badge ok" id="statusBadge">OK</span>
        <span id="statusText">System Ready</span>
      </div>
      
      <div class="group">
        <label class="subtab">
          Rows: 
          <select id="topSelect" style="border:none; background:transparent; font-weight:700;">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </label>
        <label class="subtab">
          View:
          <select id="viewSelect" style="border:none; background:transparent; font-weight:700;">
            <option value="cards">Cards</option>
            <option value="raw">JSON</option>
          </select>
        </label>
      </div>
    </div>

    <nav class="tabs" id="industryTabs" role="tablist"></nav>

    <section id="industryViews">
      </section>

    <div class="view" id="debugView">
      <pre id="rawJson" class="carditem" style="font-size: 11px; overflow: auto;"></pre>
    </div>

  </main>

  <script>
    (() => {
      "use strict";

      // Configuration
      const API_BASE = window.API_BASE || `${location.protocol}//${location.host}`;
      
      const INDUSTRIES = [
        { key: "real_estate", label: "Real Estate", tables: [
            { key: "jdas_housingmarketinsight", label: "Housing Market Insight" },
            { key: "jdas_marketoutlook", label: "Market Outlook" }
        ]},
        { key: "automotive", label: "Automotive", tables: [
            { key: "jdas_vehiclesalesforecast", label: "Sales Forecast" }
        ]},
        { key: "analytics_ops", label: "Analytics & Ops", tables: [
            { key: "jdas_analyticsparadigm", label: "Paradigm" }
        ]},
        { key: "ai", label: "AI Developments", tables: [
            { key: "jdas_aiindustryinsight", label: "AI Insights" }
        ]},
        { key: "market", label: "Market Insight", tables: [
            { key: "jdas_marketinsight", label: "Market Insight" },
            { key: "jdas_markettrendinsight", label: "Trend Insight" }
        ]}
      ];

      const FIELD_MAP = {
        title: ["title","name","topic","headline"],
        body: ["body","insight","notes","content","text","description"],
        tag: ["tag", "category"]
      };

      // Helper to grab first available data field
      const pick = (obj, keys) => {
        for (const k of keys) if (obj?.[k]) return obj[k];
        return "";
      };

      const state = {
        blocks: {},
        activeIndustry: "real_estate",
        activeTable: ""
      };

      // --- Rendering Logic ---

      function renderIndustryNav() {
        const nav = document.getElementById("industryTabs");
        nav.innerHTML = INDUSTRIES.map(ind => `
          <div class="tab" data-key="${ind.key}" role="tab">
            ${ind.label}
          </div>
        `).join('');
      }

      async function updateDisplay() {
        const container = document.getElementById("industryViews");
        const ind = INDUSTRIES.find(i => i.key === state.activeIndustry);
        
        // Update Nav UI
        document.querySelectorAll('.tab').forEach(t => {
          t.setAttribute('aria-selected', t.dataset.key === state.activeIndustry);
        });

        if (!ind) return;

        // Set default table if none selected for this industry
        if (!state.activeTable || !ind.tables.some(t => t.key === state.activeTable)) {
          state.activeTable = ind.tables[0].key;
        }

        // Build HTML for the single active view
        const items = state.blocks[state.activeIndustry]?.items || [];
        const filtered = items.filter(item => item.table === state.activeTable);

        container.innerHTML = `
          <div class="view active">
            <div class="subtabs">
              ${ind.tables.map(t => `
                <div class="subtab" data-table="${t.key}" aria-selected="${t.key === state.activeTable}">
                  ${t.label}
                </div>
              `).join('')}
            </div>
            <div class="cards">
              ${filtered.length ? filtered.map(row => `
                <div class="carditem">
                  <div class="meta">${pick(row, FIELD_MAP.tag)}</div>
                  <div class="t">${pick(row, FIELD_MAP.title)}</div>
                  <div class="b">${pick(row, FIELD_MAP.body)}</div>
                </div>
              `).join('') : '<div class="carditem">No updates available for this section.</div>'}
            </div>
          </div>
        `;
      }

      // --- Data Fetching ---

      async function fetchData() {
        const status = document.getElementById("statusText");
        const top = document.getElementById("topSelect").value;
        status.textContent = "Updating...";
        
        try {
          const res = await fetch(`${API_BASE}/api/v1/summary/industry-updates?top=${top}`);
          const data = await res.json();
          if (data.ok) {
            state.blocks = data.blocks;
            status.textContent = "Last updated: " + new Date().toLocaleTimeString();
            updateDisplay();
            // Update Debug view
            document.getElementById("rawJson").textContent = JSON.stringify(data, null, 2);
          }
        } catch (e) {
          status.textContent = "Connection Error";
        }
      }

      // --- Event Listeners ---

      document.addEventListener("click", (e) => {
        const tab = e.target.closest(".tab");
        const subtab = e.target.closest(".subtab");

        if (tab) {
          state.activeIndustry = tab.dataset.key;
          state.activeTable = ""; // Reset table to default for new industry
          updateDisplay();
        }

        if (subtab) {
          state.activeTable = subtab.dataset.table;
          updateDisplay();
        }
      });

      document.getElementById("refreshBtn").onclick = fetchData;
      document.getElementById("topSelect").onchange = fetchData;
      document.getElementById("viewSelect").onchange = (e) => {
        document.getElementById("debugView").style.display = e.target.value === "raw" ? "block" : "none";
        document.getElementById("industryViews").style.display = e.target.value === "raw" ? "none" : "block";
      };

      // --- Init ---
      document.addEventListener("DOMContentLoaded", () => {
        renderIndustryNav();
        fetchData();
      });

    })();
  </script>
</body>
</html>
