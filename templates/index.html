<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JD Analytics &amp; Solutions — Tailored Industry Updates</title>

  <!-- Bump ?v to bust cache when you change CSS -->
  <link rel="stylesheet" href="/static/style.css?v=2026-01-03-tabs-a" />
</head>

<body>
  <!-- Top Bar -->
  <header class="appbar">
    <div class="title">JD Analytics &amp; Solutions — Tailored Industry Updates</div>
    <div class="right">
      <span class="pill" id="buildPill">Build: 2026-01-03 (tabs)</span>
      <span class="pill" id="apiPill">API: …</span>
    </div>
  </header>

  <main class="container">

    <!-- Status / Controls Panel -->
    <section class="panel" aria-label="Status and Controls">
      <div class="panel-head">
        <h2>Industry Updates</h2>
        <div class="status">
          <span class="badge ok" id="statusBadge">OK</span>
          <span id="statusText">Ready.</span>
        </div>
      </div>

      <div class="panel-body">
        <div class="toolbar">
          <div class="group">
            <label class="pill" for="topSelect">
              Rows per section
              <select id="topSelect" style="margin-left:.5rem">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </label>

            <label class="pill" for="viewSelect">
              View
              <select id="viewSelect" style="margin-left:.5rem">
                <option value="cards" selected>Cards</option>
                <option value="raw">Raw JSON (debug)</option>
              </select>
            </label>

            <span class="pill">Sort: <span class="mono">createdon desc</span></span>
          </div>

          <div class="group">
            <span class="pill">Endpoint: <span class="mono">/api/v1/summary/industry-updates</span></span>
            <span class="pill">Docs: <a id="docsLink" href="#" target="_blank" rel="noopener">/docs</a></span>
            <button class="btn primary" id="refreshBtn" type="button">Refresh</button>
          </div>
        </div>

        <!-- Industry Tabs -->
        <div class="tabs" id="industryTabs" aria-label="Industry tabs"></div>

        <!-- Industry Views (subtabs + cards render here) -->
        <div id="industryViews" aria-live="polite"></div>

        <!-- Debug -->
        <div class="view" id="debugView" style="margin-top:12px; display:none;">
          <div class="subtabs" style="justify-content:space-between; align-items:center;">
            <span class="pill">Raw Payload (Debug)</span>
          </div>
          <details open>
            <summary>Show JSON</summary>
            <pre class="mono" id="rawJson">(loading)</pre>
          </details>
        </div>

      </div>
    </section>

  </main>

  <!-- ========== Config (Wix embedding) ==========
       If this page is embedded in Wix and your API is on Render,
       uncomment and set the backend URL:
  <script>window.API_BASE = "https://jdas-backend.onrender.com";</script>
  ============================================ -->

  <!-- app.js (tabs + subtabs renderer) -->
  <script>
  /* ======================================
     JDAS Tailored Industry Updates — app.js
     Tabs (Industry) + Subtabs (Sections)
     Matches style.css: .tabs/.tab + .subtabs/.subtab + .view/.active + .cards/.carditem
     ====================================== */

  (() => {
    "use strict";

    /* ---------- API base ---------- */
    const API_BASE =
      (window.API_BASE && String(window.API_BASE).trim()) ||
      (document.documentElement?.dataset?.apiBase && String(document.documentElement.dataset.apiBase).trim()) ||
      `${location.protocol}//${location.host}`;

    /* ---------- Helpers ---------- */
    const isObj = (x) => x && typeof x === "object" && !Array.isArray(x);

    function buildQS(params) {
      if (!params) return "";
      const usp = new URLSearchParams();
      for (const [k, v] of Object.entries(params)) {
        if (v === undefined || v === null || v === "") continue;
        usp.set(k, String(v));
      }
      const s = usp.toString();
      return s ? `?${s}` : "";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setStatus(kind, text) {
      const badge = document.getElementById("statusBadge");
      const label = document.getElementById("statusText");
      if (badge) {
        badge.classList.remove("ok", "err");
        badge.classList.add(kind === "ok" ? "ok" : "err");
        badge.textContent = kind === "ok" ? "OK" : "ERR";
      }
      if (label) label.textContent = text || "";
    }

    /* ---------- Fetch ---------- */
    async function fetchJSON(path, { method = "GET", body = null, timeoutMs = 20000 } = {}) {
      const url = `${API_BASE}${path}`;
      const ac = new AbortController();
      const timer = setTimeout(() => ac.abort(new DOMException("Timeout", "AbortError")), timeoutMs);

      try {
        const hasBody = body !== null && body !== undefined;

        const res = await fetch(url, {
          method,
          cache: "no-store",
          signal: ac.signal,
          headers: {
            "Accept": "application/json",
            ...(hasBody ? { "Content-Type": "application/json" } : {})
          },
          body: hasBody ? (typeof body === "string" ? body : JSON.stringify(body)) : null
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} ${res.statusText} — ${url}\n${text.slice(0, 500)}`);
        }

        return await res.json();
      } finally {
        clearTimeout(timer);
      }
    }

    /* ---------- Normalizers ---------- */
    function asSummaryBlocks(payload) {
      if (!isObj(payload) || payload.ok !== true || !isObj(payload.blocks)) return {};
      return payload.blocks;
    }

    /* ---------- API ---------- */
    async function getIndustrySummary({ top = 10, orderby = "createdon desc", timeoutMs = 25000 } = {}) {
      const qs = buildQS({ top, orderby });
      const data = await fetchJSON(`/api/v1/summary/industry-updates${qs}`, { timeoutMs });
      return asSummaryBlocks(data);
    }

    /* ---------- UI Model ---------- */
    const INDUSTRIES = Object.freeze([
      { key: "real_estate",   label: "Real Estate" },
      { key: "automotive",    label: "Automotive" },
      { key: "analytics_ops", label: "Business Analytics & Ops" },
      { key: "ai",            label: "AI Developments" },
      { key: "market",        label: "Market Insight" },
      { key: "outlook",       label: "Market Outlook" },
      { key: "trends",        label: "Market Trends" },
      { key: "analysis",      label: "Market Analysis" }
    ]);

    const FIELD = Object.freeze({
      title: ["jdas_title","jdas_headline","jdas_name","name","title","subject","topic","headline"],
      desc:  ["jdas_summary","jdas_description","summary","description","detail","subtitle"],
      body:  ["body","jdas_notes","notes","content","text","insight"],
      date:  ["createdon","modifiedon","jdas_date","date","timestamp"]
    });

    function pick(obj, keys) {
      for (const k of keys) {
        const v = obj?.[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return "";
    }

    function formatDate(v) {
      if (!v) return "";
      const d = new Date(v);
      if (isNaN(d.getTime())) return String(v);
      return d.toLocaleString();
    }

    function getSubtabKeys(items) {
      // Use unique titles as subtabs (matches your current data structure)
      const titles = items
        .map(x => String(pick(x, FIELD.title) || "").trim())
        .filter(Boolean);
      return [...new Set(titles)];
    }

    /* ---------- Rendering ---------- */
    function renderShell() {
      const tabsEl = document.getElementById("industryTabs");
      const viewsEl = document.getElementById("industryViews");

      tabsEl.innerHTML = "";
      viewsEl.innerHTML = "";

      for (const ind of INDUSTRIES) {
        // top tab
        const tab = document.createElement("button");
        tab.type = "button";
        tab.className = "tab";
        tab.textContent = ind.label;
        tab.dataset.industry = ind.key;
        tab.setAttribute("aria-selected", "false");
        tabsEl.appendChild(tab);

        // view container
        const view = document.createElement("div");
        view.className = "view";
        view.dataset.industryView = ind.key;

        const subtabs = document.createElement("div");
        subtabs.className = "subtabs";
        subtabs.dataset.subtabs = ind.key;

        const content = document.createElement("div");
        content.dataset.content = ind.key;

        view.appendChild(subtabs);
        view.appendChild(content);
        viewsEl.appendChild(view);
      }
    }

    function setActiveIndustry(industryKey) {
      document.querySelectorAll(".tab").forEach(btn => {
        btn.setAttribute("aria-selected", btn.dataset.industry === industryKey ? "true" : "false");
      });
      document.querySelectorAll(".view").forEach(v => {
        v.classList.toggle("active", v.dataset.industryView === industryKey);
      });
    }

    function setActiveSubtab(industryKey, subtabLabel) {
      document.querySelectorAll(`.subtabs[data-subtabs="${industryKey}"] .subtab`).forEach(btn => {
        btn.setAttribute("aria-selected", btn.dataset.subtab === subtabLabel ? "true" : "false");
      });
    }

    function renderCards(items) {
      if (!items.length) return `<div class="empty">No records found.</div>`;

      const cards = items.map((row) => {
        const t = pick(row, FIELD.title) || "Update";
        const desc = pick(row, FIELD.desc);
        const body = pick(row, FIELD.body);
        const date = formatDate(pick(row, FIELD.date));

        return `
          <div class="carditem">
            <div class="t">${escapeHtml(t)}</div>
            ${date ? `<div class="d">${escapeHtml(date)}</div>` : ``}
            ${desc ? `<div class="d">${escapeHtml(desc)}</div>` : ``}
            ${body ? `<div class="b">${escapeHtml(String(body)).slice(0, 320)}</div>` : ``}
          </div>
        `.trim();
      }).join("");

      return `<div class="cards">${cards}</div>`;
    }

    function renderIndustry(state, industryKey) {
      const block = state.blocks?.[industryKey];
      const items = (block && Array.isArray(block.items)) ? block.items : [];

      const subtabsEl = document.querySelector(`.subtabs[data-subtabs="${industryKey}"]`);
      const contentEl = document.querySelector(`[data-content="${industryKey}"]`);
      if (!subtabsEl || !contentEl) return;

      if (!items.length) {
        subtabsEl.innerHTML = "";
        contentEl.innerHTML = `<div class="empty">No records found.</div>`;
        return;
      }

      const keys = getSubtabKeys(items);

      // If no usable subtab keys, render all
      if (!keys.length) {
        subtabsEl.innerHTML = "";
        contentEl.innerHTML = renderCards(items);
        return;
      }

      // Build subtabs
      subtabsEl.innerHTML = keys.map((label, idx) => {
        const selected = idx === 0 ? "true" : "false";
        return `
          <button type="button"
                  class="subtab"
                  data-industry="${escapeHtml(industryKey)}"
                  data-subtab="${escapeHtml(label)}"
                  aria-selected="${selected}">
            ${escapeHtml(label)}
          </button>
        `.trim();
      }).join("");

      // Default: first subtab bucket
      const first = keys[0];
      state.activeSubtabs[industryKey] = first;
      const bucket = items.filter(x => String(pick(x, FIELD.title) || "").trim() === first);
      contentEl.innerHTML = renderCards(bucket);
    }

    function bindEvents(state) {
      const tabsEl = document.getElementById("industryTabs");
      const viewsEl = document.getElementById("industryViews");
      const refreshBtn = document.getElementById("refreshBtn");
      const topSelect = document.getElementById("topSelect");
      const viewSelect = document.getElementById("viewSelect");
      const debugView = document.getElementById("debugView");
      const rawJson = document.getElementById("rawJson");

      tabsEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".tab");
        if (!btn) return;
        state.activeIndustry = btn.dataset.industry;
        setActiveIndustry(state.activeIndustry);
      });

      viewsEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".subtab");
        if (!btn) return;

        const industryKey = btn.dataset.industry;
        const subtabLabel = btn.dataset.subtab;

        state.activeIndustry = industryKey;
        state.activeSubtabs[industryKey] = subtabLabel;

        setActiveIndustry(industryKey);
        setActiveSubtab(industryKey, subtabLabel);

        const items = state.blocks?.[industryKey]?.items || [];
        const bucket = items.filter(x => String(pick(x, FIELD.title) || "").trim() === subtabLabel);
        const contentEl = document.querySelector(`[data-content="${industryKey}"]`);
        if (contentEl) contentEl.innerHTML = renderCards(bucket);
      });

      refreshBtn?.addEventListener("click", async () => {
        await loadDashboard(state);
      });

      topSelect?.addEventListener("change", async () => {
        await loadDashboard(state);
      });

      viewSelect?.addEventListener("change", () => {
        const mode = viewSelect.value;
        if (debugView) debugView.style.display = (mode === "raw") ? "block" : "none";
      });

      // Expose debug refs
      state._debug = { rawJson, debugView };
    }

    async function loadDashboard(state) {
      const apiPill = document.getElementById("apiPill");
      const docsLink = document.getElementById("docsLink");
      const topSelect = document.getElementById("topSelect");
      const viewSelect = document.getElementById("viewSelect");

      if (apiPill) apiPill.textContent = `API: ${API_BASE}`;
      if (docsLink) docsLink.href = `${API_BASE}/docs`;

      // Loading
      setStatus("ok", "Loading latest updates…");
      for (const ind of INDUSTRIES) {
        const contentEl = document.querySelector(`[data-content="${ind.key}"]`);
        if (contentEl) contentEl.innerHTML = `<div class="loading">Loading…</div>`;
        const subtabsEl = document.querySelector(`.subtabs[data-subtabs="${ind.key}"]`);
        if (subtabsEl) subtabsEl.innerHTML = "";
      }

      const top = parseInt(topSelect?.value || "10", 10);
      const orderby = "createdon desc";

      try {
        const blocks = await getIndustrySummary({ top, orderby });
        state.blocks = blocks;

        // Render each industry view
        for (const ind of INDUSTRIES) {
          renderIndustry(state, ind.key);
        }

        // Keep active industry sane
        if (!state.activeIndustry) state.activeIndustry = INDUSTRIES[0].key;
        setActiveIndustry(state.activeIndustry);

        // Debug JSON
        if (state._debug?.rawJson && viewSelect?.value === "raw") {
          state._debug.rawJson.textContent = JSON.stringify({ ok:true, blocks }, null, 2);
        }

        setStatus("ok", "Loaded latest updates.");
      } catch (err) {
        console.error(err);
        setStatus("err", "Failed to load updates. Check API_BASE / endpoint.");

        for (const ind of INDUSTRIES) {
          const contentEl = document.querySelector(`[data-content="${ind.key}"]`);
          if (contentEl) contentEl.innerHTML = `<div class="empty">Error loading data.</div>`;
        }
        if (state._debug?.rawJson) state._debug.rawJson.textContent = String(err?.message || err);
      }
    }

    // Boot
    document.addEventListener("DOMContentLoaded", async () => {
      const state = {
        blocks: {},
        activeIndustry: "real_estate",
        activeSubtabs: Object.create(null),
        _debug: null
      };

      renderShell();
      bindEvents(state);
      setActiveIndustry(state.activeIndustry);

      // Default debug view hidden
      const debugView = document.getElementById("debugView");
      if (debugView) debugView.style.display = "none";

      // Initial load
      await loadDashboard(state);

      // Expose reload for manual testing
      window.JDAS_UI = {
        reload: (opts) => loadDashboard(state, opts),
        get state() { return state; }
      };

      console.log("[JDAS] API_BASE:", API_BASE);
    });

  })();
  </script>
</body>
</html>
