<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JD Analytics &amp; Solutions — Current Events in Business</title>

  <!-- bump the query when you change CSS to bust cache -->
  <link rel="stylesheet" href="/static/style.css?v=2025-10-09-b" />
</head>
<body>
  <!-- Top Bar -->
  <header class="appbar">
    <div class="title">JD Analytics &amp; Solutions — Current Events in Business</div>
    <div class="right">
      <span class="pill">Build: 2025-10-09b</span>
      <span class="pill" id="apiPill">API: …</span>
    </div>
  </header>

  <main class="container">
    <!-- Category Tabs -->
    <nav class="category-bar" id="categoryBar" role="tablist" aria-label="Main categories"></nav>

    <!-- Subtable Tabs -->
    <nav class="subtable-bar" id="subtabs" role="tablist" aria-label="Datasets"></nav>

    <!-- Status -->
    <section class="card">
      <div class="status">
        <span class="badge" id="statusBadge">Checking…</span>
        <span id="statusText">Warming up API.</span>
        <span class="hint">Docs: <a id="docsLink" href="#" target="_blank" rel="noopener">/docs</a></span>
      </div>
    </section>

    <!-- Data -->
    <section class="card">
      <h2 id="contentTitle" class="card-title">Select a dataset</h2>
      <div id="mount" class="empty">No data loaded yet.</div>
    </section>

    <div class="spacer"></div>
  </main>

  <script>
    // ---------- API base ----------
    const API_BASE = `${location.protocol}//${location.host}`;
    document.getElementById("apiPill").textContent = `API: ${API_BASE}`;
    const docsLink = document.getElementById("docsLink"); if (docsLink) docsLink.href = `${API_BASE}/docs`;

    // ---------- NEW TABLES (full set you asked for) ----------
    const TABLES = {
      trade: {
        label: "U.S. Trade",
        items: [
          { key:"tradeDeficitAnnual",  label:"Trade Deficit Annual",      path:"/api/trade-deficit-annual" },
          { key:"tariffByCountry",     label:"Tariff % by Country",       path:"/api/tariff-by-country" },
          { key:"tariffByItem",        label:"Tariff By Item",            path:"/api/tariff-by-item" },
          { key:"tradeDeals",          label:"Trade Deals",               path:"/api/trade-deals" },
          { key:"tariffRevenue",       label:"Tariff Revenue",            path:"/api/tariff-revenue" }
        ]
      },
      kpi: {
        label: "KPI / Key Stats",
        items: [
          { key:"unemploymentRate",    label:"Unemployment Rate",         path:"/api/unemployment-rate" },
          { key:"inflationRate",       label:"Inflation Rate",            path:"/api/inflation-rate" },
          { key:"economicIndicatorA",  label:"Economic Indicator (A)",    path:"/api/economic-indicator" },
          { key:"manufacturingPMI",    label:"Manufacturing PMI Report",  path:"/api/manufacturing-pmi-report" },
          { key:"weeklyClaims",        label:"Weekly Claims Report",      path:"/api/weekly-claims-report" },
          { key:"consumerConfidence",  label:"Consumer Confidence Index", path:"/api/consumer-confidence-index" },
          { key:"treasuryYields",      label:"Treasury Yields Record",    path:"/api/treasury-yields-record" },
          { key:"economicGrowth",      label:"Economic Growth Report",    path:"/api/economic-growth-report" },
          { key:"economicIndicatorB",  label:"Economic Indicator (B)",    path:"/api/economic-indicator-1" }
        ]
      },
      global: {
        label: "Global Events",
        items: [
          { key:"corporateSpinoff",    label:"Corporate SpinOff",         path:"/api/corporate-spinoff" },
          { key:"conflictRecord",      label:"Conflict Record",           path:"/api/conflict-record" },
          { key:"globalDisasters",     label:"Global Natural Disasters",  path:"/api/global-natural-disasters" }
        ]
      },
      labor: {
        label: "Labor & Society",
        items: [
          { key:"publicRevenueLoss",   label:"Publicly Annouced Revenue Loss", path:"/api/publicly-annouced-revenue-loss" },
          { key:"layoffAnnouncement",  label:"Layoff Announcement",             path:"/api/layoff-announcement" },
          { key:"acquisitionDeal",     label:"Acquisition Deal",                path:"/api/acquisition-deal" },
          { key:"bankruptcyLog",       label:"Bankruptcy Log",                  path:"/api/bankruptcies" },
          { key:"layoffs",             label:"Layoff Tracking",                 path:"/api/layoffs" }
        ]
      },
      energy: {
        label: "Environmental & Energy",
        items: [
          { key:"envReg",              label:"Environmental Regulation",  path:"/api/environmental-regulation" },
          { key:"envPolicy",           label:"Environmental Policy",      path:"/api/environmental-policy" },
          { key:"infraInvestment",     label:"Infrastructure Investment", path:"/api/infrastructure-investment" }
        ]
      }
    };

    // ---------- Refs ----------
    const $         = s => document.querySelector(s);
    const statusB   = $("#statusBadge");
    const statusT   = $("#statusText");
    const mount     = $("#mount");
    const catBar    = $("#categoryBar");
    const subtabs   = $("#subtabs");
    const titleEl   = $("#contentTitle");

    // ---------- Status ----------
    function setStatus(kind, text){
      statusB?.classList.remove("ok","err");
      if (kind === "ok")  statusB?.classList.add("ok");
      if (kind === "err") statusB?.classList.add("err");
      if (statusB) statusB.textContent = (kind === "ok" ? "OK" : kind === "err" ? "Error" : "Loading…");
      if (statusT) statusT.textContent = text || "";
    }

    async function fetchJSON(path, opts = {}){
      const url = `${API_BASE}${path}`;
      const res = await fetch(url, { cache:"no-store", headers:{ "Accept":"application/json" }, ...opts });
      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${url}\n${txt.slice(0,300)}`);
      }
      return res.json();
    }

    function escapeHTML(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
    function valueToText(v){ if (v==null) return ""; if (typeof v==="object") return JSON.stringify(v); return String(v); }

    function renderTable(rows){
      if (!Array.isArray(rows) || rows.length === 0){
        mount.className = "empty";
        mount.textContent = "No rows found.";
        return;
      }
      const cols = Array.from(rows.reduce((s,r)=>{Object.keys(r||{}).forEach(k=>s.add(k)); return s;}, new Set()));
      const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHTML(c)}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${rows.map(r=>`<tr>${
        cols.map(c=>`<td>${escapeHTML(valueToText(r[c]))}</td>`).join("")
      }</tr>`).join("")}</tbody>`;
      mount.className = "tablewrap";
      mount.innerHTML = `<table>${thead}${tbody}</table>`;
    }

    // ---------- Build UI ----------
    let currentCat = null;
    let currentKey = null;

    function buildCats(){
      const cats = Object.keys(TABLES);
      catBar.innerHTML = cats.map((c,i)=>`<button class="nav-btn ${i===0?"active":""}" data-cat="${c}" role="tab" aria-selected="${i===0}">${escapeHTML(TABLES[c].label)}</button>`).join("");
      currentCat = cats[0];
    }

    function buildSubtabs(){
      const items = TABLES[currentCat].items;
      subtabs.innerHTML = items.map((it,i)=>`<button class="nav-btn ${i===0?"active":""}" data-key="${it.key}" role="tab" aria-selected="${i===0}">${escapeHTML(it.label)}</button>`).join("");
      currentKey = items[0].key;
    }

    async function loadCurrent(){
      const group = TABLES[currentCat];
      const item  = group.items.find(i => i.key === currentKey);
      const title = `${group.label} — ${item.label}`;
      titleEl.textContent = title;

      try{
        setStatus("", `Loading ${item.label}…`);
        mount.className = "loading";
        mount.textContent = `Loading ${item.label}…`;
        const data = await fetchJSON(item.path);
        renderTable(Array.isArray(data) ? data : (data?.value || []));
        setStatus("ok", `Loaded ${item.label}.`);
      }catch(err){
        mount.className = "empty";
        mount.innerHTML = `<div class="error">Failed to load ${escapeHTML(item.label)}.</div><pre class="hint">${escapeHTML(err.message)}</pre>`;
        setStatus("err", `Failed to load ${item.label}.`);
      }
    }

    // interactions
    catBar.addEventListener("click", e=>{
      const btn = e.target.closest("button[data-cat]"); if (!btn) return;
      if (btn.dataset.cat === currentCat) return;
      [...catBar.querySelectorAll("button[data-cat]")].forEach(b => b.classList.toggle("active", b===btn));
      currentCat = btn.dataset.cat;
      buildSubtabs();
      loadCurrent();
    });

    subtabs.addEventListener("click", e=>{
      const btn = e.target.closest("button[data-key]"); if (!btn) return;
      if (btn.dataset.key === currentKey) return;
      [...subtabs.querySelectorAll("button[data-key]")].forEach(b => b.classList.toggle("active", b===btn));
      currentKey = btn.dataset.key;
      loadCurrent();
    });

    // ---------- Health warmup (try /api/health then /health) ----------
    (async ()=>{
      for (let i=0;i<6;i++){
        try {
          const j = await fetchJSON("/api/health");
          if (j && j.ok){ setStatus("ok","API ready."); break; }
        } catch {
          try {
            const j2 = await fetchJSON("/health");
            if (j2 && j2.ok){ setStatus("ok","API ready."); break; }
          } catch {}
          setStatus("", "Warming API…");
        }
        await new Promise(r=>setTimeout(r, 4000));
      }
    })();

    // boot
    buildCats();
    buildSubtabs();
    loadCurrent();
  </script>
</body>
</html>
