<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JD Analytics &amp; Solutions — Current Events in Business</title>

  <!-- Theme / layout styles (bump ?v when you deploy) -->
  <link rel="stylesheet" href="/static/style.css?v=2025-10-05-e">

  <!-- Minimal utility -->
  <style>.hidden{display:none !important}</style>
</head>

<body>
  <!-- Top Bar -->
  <div class="appbar">
    <div class="title">JD Analytics &amp; Solutions — Current Events in Business</div>
    <div style="display:flex; gap:8px; align-items:center">
      <div class="pill">Build: 2025-10-05e</div>
      <div class="pill" id="apiPill">API: …</div>
    </div>
  </div>

  <div class="container">
    <!-- CATEGORY BUTTONS -->
    <div class="category-bar" id="categoryBar" role="tablist" aria-label="Main categories">
      <button class="nav-btn active" data-cat="trade"   aria-selected="true" role="tab">U.S. Trade</button>
      <button class="nav-btn"         data-cat="kpi"     role="tab">KPI / Key Stats</button>
      <button class="nav-btn"         data-cat="global"  role="tab">Global Events</button>
      <button class="nav-btn"         data-cat="labor"   role="tab">Labor &amp; Society</button>
      <button class="nav-btn"         data-cat="energy"  role="tab">Environmental &amp; Energy</button>
    </div>

    <!-- SUBTABLE BUTTONS (shown per category) -->
    <div class="subtable-bar" id="subtabs-trade" role="tablist" aria-label="U.S. Trade subtabs">
      <button class="nav-btn active" data-sub="investments"      aria-selected="true" role="tab">Company Investments</button>
      <button class="nav-btn"         data-sub="tariffByCountry" role="tab">Tariff % by Country</button>
    </div>
    <div class="subtable-bar hidden" id="subtabs-kpi"    role="tablist" aria-label="KPI subtabs"></div>
    <div class="subtable-bar hidden" id="subtabs-global" role="tablist" aria-label="Global Events subtabs"></div>
    <div class="subtable-bar hidden" id="subtabs-labor"  role="tablist" aria-label="Labor &amp; Society subtabs">
      <button class="nav-btn active" data-sub="bankruptcy" role="tab">Bankruptcy Log</button>
      <button class="nav-btn"         data-sub="layoffs"    role="tab">Layoff Tracking</button>
    </div>
    <div class="subtable-bar hidden" id="subtabs-energy" role="tablist" aria-label="Environmental &amp; Energy subtabs"></div>

    <!-- Content host -->
    <section id="contentHost" class="section-host" aria-live="polite">
      <h3 id="contentTitle" style="margin:0 0 8px;">U.S. Trade — Company Investments</h3>
      <div style="opacity:.8">Select a sub-category to view data.</div>
    </section>

    <!-- Status -->
    <div class="card" aria-label="Status">
      <div class="status">
        <span class="badge" id="statusBadge">Checking…</span>
        <span id="statusText">Warming up API.</span>
      </div>
    </div>

    <!-- Content stack -->
    <div class="stack">
      <section class="card" aria-label="Slides">
        <h2>JDAS Charts (Google Slides)</h2>
        <iframe
          src="https://docs.google.com/presentation/d/e/2PACX-1vRGJlR4RGlAk94AcAzCwfCT4SoWWmQRjuLHqT7mQm-8skb7zhPzvJKyqGs60i-XT_siGPS4m_vKAHrc/embed?start=false&loop=false&delayms=3000"
          width="100%" height="480" frameborder="0" allowfullscreen
          style="border:0; border-radius:12px; background:#0b0f15"></iframe>
      </section>

      <section class="card" aria-label="Data">
        <h2 id="cardTitle">Dataset</h2>
        <div id="mount" class="empty">No data loaded yet.</div>
      </section>

      <section class="card" aria-label="Chatbot">
        <h2>Ask JDAS (Chatbot)</h2>
        <iframe
          src="https://www.chatbase.co/chatbot-iframe/Vndl5JBBKFxsFxy9De-K1"
          width="100%" height="560" frameborder="0"
          style="border:0; border-radius:12px; background:transparent"
          allow="clipboard-read; clipboard-write"></iframe>
        <div class="hint">First call may take a few seconds while the API wakes.</div>
      </section>
    </div>

    <div class="spacer"></div>
    <div class="hint">Open API docs: <a href="#" id="docsLink" target="_blank" rel="noopener">/docs</a></div>
  </div>

  <!-- ===== Helpers: production API base + shared JS (ONE COPY) ===== -->
  <script>window.API_BASE = "https://jdas-backend.onrender.com";</script>
  <script src="/static/app.js?v=7" onerror="console.warn('app.js failed; using fallback')"></script>

  <!-- ===== Fallback if /static/app.js didn't load ===== -->
  <script>
  (function ensureJDAS(){
    if (window.JDAS && window.JDAS.api) return; // helpers loaded fine
    const API_BASE = (window.API_BASE && String(window.API_BASE).trim())
      || `${location.protocol}//${location.host}`;
    async function fetchJSON(path, { method="GET", body=null } = {}) {
      const url = `${API_BASE}${path}`;
      const res = await fetch(url, { method, body, cache: "no-store", headers: { "Accept": "application/json" } });
      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${url}\n${txt.slice(0,240)}`);
      }
      return res.json();
    }
    window.JDAS = {
      API_BASE,
      api: {
        companyInvestments: (top=5000) => fetchJSON(`/api/company-investments?top=${encodeURIComponent(top)}`),
        bankruptcies:       ()          => fetchJSON("/api/bankruptcies"),
        layoffs:            ()          => fetchJSON("/api/layoffs"),
        tariffByCountry:    ()          => fetchJSON("/api/tariff-by-country"),
        health:             ()          => fetchJSON("/health")
      }
    };
    console.warn("JDAS fallback active (app.js missing or cached stale).");
  })();
  </script>

  <!-- ===== Page logic: wire UI + load data ===== -->
  <script>
    // DOM refs
    const apiPill      = document.getElementById("apiPill");
    const docsLink     = document.getElementById("docsLink");
    const statusBadge  = document.getElementById("statusBadge");
    const statusText   = document.getElementById("statusText");
    const cardTitle    = document.getElementById("cardTitle");
    const mount        = document.getElementById("mount");
    const catBar       = document.getElementById("categoryBar");
    const contentTitle = document.getElementById("contentTitle");

    const subtabGroups = {
      trade:  document.getElementById('subtabs-trade'),
      kpi:    document.getElementById('subtabs-kpi'),
      global: document.getElementById('subtabs-global'),
      labor:  document.getElementById('subtabs-labor'),
      energy: document.getElementById('subtabs-energy'),
    };

    // Show API base / docs
    const { API_BASE, api } = window.JDAS;
    if (apiPill)  apiPill.textContent = `API: ${API_BASE}`;
    if (docsLink) docsLink.href = `${API_BASE}/docs`;

    // Status helpers
    function setStatus(kind, text){
      if (!statusBadge || !statusText) return;
      statusBadge.classList.remove("ok","err");
      if(kind==="ok")  statusBadge.classList.add("ok");
      if(kind==="err") statusBadge.classList.add("err");
      statusBadge.textContent = kind==="ok" ? "OK" : kind==="err" ? "Error" : "Loading…";
      statusText.textContent  = text;
    }

    // Warm-up health check (Render cold start)
    (async () => {
      for (let i=0;i<6;i++){
        try {
          const j = await api.health();
          if (j && j.ok){ setStatus("ok","API ready."); break; }
        } catch {
          setStatus("", "Warming API (Render may take ~30–60s)...");
        }
        await new Promise(r=>setTimeout(r,5000));
      }
    })();

    // Table renderer
    function escapeHTML(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
    function valueToText(v){ if (v==null) return ""; if (typeof v==="object") return JSON.stringify(v); return String(v); }
    function renderTable(rows){
      if(!rows || rows.length===0){ mount.className="empty"; mount.innerHTML="No rows found."; return; }
      const cols = Array.from(rows.reduce((s,r)=>{Object.keys(r).forEach(k=>s.add(k)); return s;}, new Set()));
      const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHTML(c)}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${
        rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHTML(valueToText(r[c]))}</td>`).join("")}</tr>`).join("")
      }</tbody>`;
      mount.className="tablewrap"; mount.innerHTML = `<table>${thead}${tbody}</table>`;
    }

    // State
    let currentCat = 'trade';
    let currentSub = 'investments';

    // Dataset loaders
    const LOADERS = {
      trade: {
        investments:     { label: "Company Investments",   fn: () => api.companyInvestments(5000) },
        tariffByCountry: { label: "Tariff % by Country",   fn: api.tariffByCountry }
      },
      labor: {
        bankruptcy:      { label: "Bankruptcy Log",        fn: api.bankruptcies },
        layoffs:         { label: "Layoff Tracking",       fn: api.layoffs }
      }
      // (wire KPI / Global / Energy later)
    };

    function buildTitle(){
      const catLabel = {
        trade: 'U.S. Trade',
        kpi: 'KPI / Key Stats',
        global: 'Global Events',
        labor: 'Labor & Society',
        energy: 'Environmental & Energy'
      }[currentCat];
      const subLabelMap = {
        investments: 'Company Investments',
        tariffByCountry: 'Tariff % by Country',
        bankruptcy: 'Bankruptcy Log',
        layoffs: 'Layoff Tracking'
      };
      const subLabel = currentSub ? ` — ${subLabelMap[currentSub]}` : '';
      return `${catLabel}${subLabel}`;
    }

    async function loadDataForSelection(){
      const group = LOADERS[currentCat] || {};
      const cfg = group[currentSub];

      // Titles
      const fullTitle = buildTitle();
      if (contentTitle) contentTitle.textContent = fullTitle;
      if (cardTitle)    cardTitle.textContent    = cfg?.label || "Dataset";

      if(!cfg){
        mount.className = "empty";
        mount.innerHTML = "No dataset wired for this category yet.";
        return;
      }

      try{
        setStatus("", `Loading ${cfg.label}…`);
        mount.className="loading";
        mount.textContent = `Loading ${cfg.label}…`;
        const rows = await cfg.fn();
        renderTable(rows);
        setStatus("ok", `Loaded ${rows.length} row(s) from ${cfg.label}.`);
      }catch(err){
        console.error(err);
        mount.className="empty";
        mount.innerHTML = `<div style="color: var(--danger)">Failed to load.</div><div class="hint">${escapeHTML(err.message)}</div>`;
        setStatus("err", `Failed to load ${cfg.label}.`);
      }
    }

    function setActive(btns, target){
      btns.forEach(b => b.classList.toggle('active', b === target));
    }

    // Category switching
    catBar.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-cat]');
      if(!btn) return;
      if(btn.dataset.cat === currentCat) return;

      setActive([...catBar.querySelectorAll('button[data-cat]')], btn);

      Object.entries(subtabGroups).forEach(([k, el])=>{
        el.classList.toggle('hidden', k !== btn.dataset.cat);
      });

      currentCat = btn.dataset.cat;
      const firstSub = subtabGroups[currentCat].querySelector('button[data-sub]');
      currentSub = firstSub ? firstSub.dataset.sub : null;

      if(firstSub){
        subtabGroups[currentCat].querySelectorAll('button[data-sub]').forEach((b,i)=>{
          b.classList.toggle('active', i===0);
        });
      }
      loadDataForSelection();
    });

    // Subtab switching
    Object.values(subtabGroups).forEach(group=>{
      group.addEventListener?.('click', (e)=>{
        const btn = e.target.closest('button[data-sub]');
        if(!btn) return;
        setActive([...group.querySelectorAll('button[data-sub]')], btn);
        currentSub = btn.dataset.sub;
        loadDataForSelection();
      });
    });

    // Boot
    loadDataForSelection();
  </script>
</body>
</html>
