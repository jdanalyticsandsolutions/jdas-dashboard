<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="/static/style.css?v=20250930">
  <meta charset="UTF-8" />
  <title>JD Analytics &amp; Solutions — Current Events in Business</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
</head>
<body>
  <!-- Top Bar -->
  <div class="appbar">
    <div class="title">JD Analytics &amp; Solutions — Current Events in Business</div>
    <div class="pill" id="apiPill">API: http://localhost:8000</div>
  </div>

  <div class="container">
    <!-- App Buttons -->
    <div class="grid" role="navigation" aria-label="Datasets">
      <button class="appbtn" data-ds="company">
        <div class="label">Company Investments</div>
        <div class="sub">Notes by company</div>
      </button>
      <button class="appbtn" data-ds="bankruptcies">
        <div class="label">Bankruptcy Log</div>
        <div class="sub">Company &amp; date logged</div>
      </button>
      <button class="appbtn" data-ds="layoffs">
        <div class="label">Layoff Tracking</div>
        <div class="sub">Date &amp; company</div>
      </button>
      <button class="appbtn" data-ds="tariffs">
        <div class="label">Tariff % by Country</div>
        <div class="sub">Rates as of Aug 1</div>
      </button>
    </div>

    <!-- Status -->
    <div class="card">
      <div class="status">
        <span class="badge" id="statusBadge">Idle</span>
        <span id="statusText">Tap a tile to load data.</span>
      </div>
    </div>

    <!-- Content stack: Slides + Data + Chatbot -->
    <div class="stack">
      <!-- Google Slides Card -->
      <section class="card" aria-label="Slides">
        <h2>JDAS Charts (Google Slides)</h2>
        <iframe
          src="https://docs.google.com/presentation/d/e/2PACX-1vRGJlR4RGlAk94AcAzCwfCT4SoWWmQRjuLHqT7mQm-8skb7zhPzvJKyqGs60i-XT_siGPS4m_vKAHrc/embed?start=false&loop=false&delayms=3000"
          width="100%" height="480" frameborder="0" allowfullscreen
          style="border:0; border-radius:12px; background:#0b0f15">
        </iframe>
      </section>

      <!-- Data Table Card -->
      <section class="card" aria-label="Data">
        <h2 id="cardTitle">Dataset</h2>
        <div id="mount" class="empty">No data loaded yet.</div>
      </section>

      <!-- Chatbot Card (reliable in embedded dashboards) -->
      <section class="card" aria-label="Chatbot">
        <h2>Ask JDAS (Chatbot)</h2>
        <iframe
          src="https://www.chatbase.co/chatbot-iframe/Vndl5JBBKFxsFxy9De-K1"
          width="100%"
          height="560"
          frameborder="0"
          style="border:0; border-radius:12px; background:transparent"
          allow="clipboard-read; clipboard-write">
        </iframe>
        <div class="hint">If the floating bubble doesn’t show in this embed, this panel will always work.</div>
      </section>
    </div>

    <div class="spacer"></div>
    <div class="hint">Tip: Open your API docs at <code>http://localhost:8000/docs</code></div>
  </div>

  <!-- ===== App Script ===== -->
  <script>
    // === Config ===
const API_BASE = location.origin; // use same origin as the page (Render domain)
    document.getElementById("apiPill").textContent = `API: ${API_BASE}`;

    // === Fetch helper ===
    async function fetchJSON(path){
      const url = `${API_BASE}${path}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }
    const api = {
      company:      () => fetchJSON("/api/company-investments"),
      bankruptcies: () => fetchJSON("/api/bankruptcies"),
      layoffs:      () => fetchJSON("/api/layoffs"),
      tariffs:      () => fetchJSON("/api/tariff-by-country"),
    };

    // === UI helpers ===
    const mount = document.getElementById("mount");
    const statusBadge = document.getElementById("statusBadge");
    const statusText = document.getElementById("statusText");
    const cardTitle = document.getElementById("cardTitle");

    function setStatus(kind, text){
      statusBadge.classList.remove("ok","err");
      if(kind==="ok") statusBadge.classList.add("ok");
      if(kind==="err") statusBadge.classList.add("err");
      statusBadge.textContent = kind==="ok" ? "OK" : kind==="err" ? "Error" : "Loading…";
      statusText.textContent = text;
    }
    function labelFor(ds){
      return ({
        company:"Company Investments",
        bankruptcies:"Bankruptcy Log",
        layoffs:"Layoff Tracking",
        tariffs:"Tariff % by Country"
      })[ds] || ds;
    }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }
    function valueToText(v){
      if (v===null || v===undefined) return "";
      if (typeof v==="object") return JSON.stringify(v);
      return String(v);
    }
    function renderTable(rows){
      if(!rows || rows.length===0){
        mount.className="empty";
        mount.innerHTML="No rows found.";
        return;
      }
      const cols = Array.from(rows.reduce((s,r)=>{Object.keys(r).forEach(k=>s.add(k)); return s;}, new Set()));
      const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHTML(c)}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${
        rows.map(r=>`<tr>${
          cols.map(c=>`<td>${escapeHTML(valueToText(r[c]))}</td>`).join("")
        }</tr>`).join("")
      }</tbody>`;
      mount.className="tablewrap";
      mount.innerHTML = `<table>${thead}${tbody}</table>`;
    }

    // === Button actions ===
    function attachActions(){
      document.querySelectorAll(".appbtn").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const ds = btn.getAttribute("data-ds");
          cardTitle.textContent = labelFor(ds);
          mount.className="loading";
          mount.textContent=`Loading ${labelFor(ds)}…`;
          setStatus("", `Loading ${labelFor(ds)}…`);
          try{
            const rows = await api[ds]();
            renderTable(rows);
            setStatus("ok", `Loaded ${rows.length} row(s) from ${labelFor(ds)}.`);
          }catch(err){
            console.error(err);
            mount.className="empty";
            mount.innerHTML = `<div style="color: var(--danger)">Failed to load.</div><div class="hint">${escapeHTML(err.message)}</div>`;
            setStatus("err", `Failed to load ${labelFor(ds)}.`);
          }
        });
      });
    }
    attachActions();
  </script>

  <!-- OPTIONAL: Floating bubble works on non-sandboxed pages (NOT inside Wix HTML embed) -->
  <!--
  <script
    src="https://www.chatbase.co/embed.min.js"
    id="chatbase-script"
    data-chatbot-id="Vndl5JBBKFxsFxy9De-K1"
    data-theme="dark"
    defer>
  </script>
  -->
</body>
</html>
